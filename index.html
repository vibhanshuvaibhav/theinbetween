<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The In-Between</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.js"></script>
    <style>
        * { 
            -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; 
            touch-action: none; outline: none; 
            font-family: sans-serif; font-weight: 200; text-transform: lowercase;
        }
        body { margin: 0; padding: 0; background: #050505; overflow: hidden; cursor: crosshair; }
        
        #gate, #end-screen {
            position: fixed; inset: 0; background: #050505; z-index: 2000;
            display: flex; align-items: center; justify-content: center; flex-direction: column;
        }

        .btn-ui {
            background: none; border: 1px solid #ffffff; color: #ffffff; 
            padding: 14px 32px; border-radius: 30px; cursor: pointer;
            font-size: 0.85rem; letter-spacing: 3px; 
            transition: all 0.6s ease;
        }

        #instruction-container {
            position: absolute; inset: 0; display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 100;
            pointer-events: none; opacity: 0; transition: opacity 1.5s ease;
            padding-top: 100px; 
        }

        #instruction-text {
            color: #ffffff; font-size: 0.85rem; line-height: 2.8; 
            letter-spacing: 1px; text-align: center; margin-bottom: 30px;
        }

        #stats-bar {
            position: absolute; top: 40px; width: 100%; display: flex; 
            justify-content: center; align-items: center; gap: 35px; color: #ffffff; 
            font-size: 0.85rem; letter-spacing: 1px; 
            pointer-events: none; opacity: 0; transition: opacity 1s;
            font-variant-numeric: tabular-nums;
        }

        #action-btn-wrapper {
            position: absolute; bottom: 45px; left: 50%; transform: translateX(-50%);
            z-index: 300; display: none;
        }

        #flash-msg {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px);
            padding: 20px 40px; border-radius: 40px; color: white;
            text-align: center; font-size: 0.85rem; letter-spacing: 1px;
            opacity: 0; transition: opacity 0.5s ease; pointer-events: none;
            z-index: 4000; border: 0.5px solid rgba(255, 255, 255, 0.2);
        }

        .bubble {
            position: absolute; background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border: 0.5px solid rgba(255, 255, 255, 0.4);
            padding: 8px 15px; border-radius: 20px; color: #ffffff;
            font-size: 11px; pointer-events: none; opacity: 0; 
            transition: opacity 0.2s; z-index: 1500 !important; /* Lowered below end-screen */
        }

        #sum-txt {
            line-height: 2.4; margin-bottom: 30px; white-space: pre-line; 
            font-size: 0.95rem; color: #fff; text-align: center;
        }
    </style>
</head>
<body>

    <div id="gate">
        <button class="btn-ui" onclick="revealGame()">enter flow state</button>
    </div>

    <div id="flash-msg">stay for at least 100s to enter flow state</div>

    <audio id="snd" loop playsinline preload="auto">
        <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
    </audio>

    <div id="instruction-container">
        <div id="instruction-text">
            follow the gold; it's your purpose<br>
            embrace the gifts found in the rhythm<br>
            protect the red; it's your peace<br>
            target 100s to enter flow state
        </div>
        <button id="start-btn" class="btn-ui" style="pointer-events: auto;" onclick="begin()">start</button>
    </div>

    <div id="stats-bar">
        <div class="stat-item" id="f-count">flow: 0s</div>
        <div class="stat-item" id="p-count">üç∞: 0</div>
        <div class="stat-item" id="d-count">üíé: 0</div>
    </div>

    <div id="action-btn-wrapper">
        <button class="btn-ui" onclick="finish()">end session</button>
    </div>

    <div id="end-screen" style="display:none;">
        <p id="sum-txt"></p>
        <button class="btn-ui" onclick="location.reload()">play again</button>
    </div>

    <div id="msg-g" class="bubble">follow me</div>
    <div id="msg-r" class="bubble">whoa...</div>

    <script>
        let gold, white, red, items = [];
        let frames = 0, pEaten = 0, dEaten = 0, active = false, gameRunning = false, angle = 0;
        let pulse = 0;
        const Y_OFF = -120;
        const REQ_FRAMES = 6000; // 100 seconds at 60fps

        function setup() {
            createCanvas(windowWidth, windowHeight);
            pixelDensity(displayDensity());
            resetPositions();
        }

        function resetPositions() {
            gold = createVector(width/2, height/2 - 180);
            white = createVector(width/2, height/2 - 140);
            red = createVector(width/2, height/2 - 100);
        }

        function revealGame() {
            document.getElementById('gate').style.display = 'none';
            document.getElementById('instruction-container').style.opacity = '1';
            let a = document.getElementById('snd');
            a.volume = 0.2; a.play().catch(()=>{});
            active = true; 
        }

        function begin() {
            gameRunning = true;
            document.getElementById('instruction-container').style.opacity = '0';
            setTimeout(() => { document.getElementById('instruction-container').style.display = 'none'; }, 1000);
            document.getElementById('action-btn-wrapper').style.display = 'block';
            document.getElementById('stats-bar').style.opacity = '0.6';
        }

        function draw() {
            background(5, 5, 5, 110);
            if (!active) return;
            pulse = sin(frameCount * 0.05) * 5;

            if (gameRunning) {
                angle += 0.007;
                let targetG = createVector(width/2 + cos(angle*0.8)*(width*0.32), height/2 + sin(angle*0.6)*(height*0.22));
                let springG = p5.Vector.lerp(targetG, white, 0.12);
                gold.lerp(springG, 0.085);

                if (mouseIsPressed || (touches && touches.length > 0)) {
                    white.lerp(createVector(mouseX, mouseY + (windowWidth > 800 ? 0 : Y_OFF)), 0.15);
                }
                red.lerp(white, 0.04);

                if (frameCount % 145 === 0) {
                    items.push({pos: createVector(random(60, width-60), random(140, height-140)), t: random()>0.4?'p':'d', l: 550});
                }
            } else {
                angle += 0.002;
                gold.y = (height/2 - 180) + sin(angle) * 10;
                white.y = (height/2 - 140) + cos(angle) * 5;
                red.y = (height/2 - 100) + sin(angle * 1.2) * 8;
            }

            for (let i = items.length-1; i >= 0; i--) {
                if (dist(white.x, white.y, items[i].pos.x, items[i].pos.y) < 45) {
                    if (items[i].t === 'p') pEaten++; else dEaten++;
                    items.splice(i, 1);
                    if (navigator.vibrate) navigator.vibrate(10); 
                } else if (--items[i].l <= 0) items.splice(i, 1);
            }

            handleMessages();
            render();
        }

        function handleMessages() {
            if (!gameRunning) return;
            let dG = dist(white.x, white.y, gold.x, gold.y);
            let dR = dist(white.x, white.y, red.x, red.y);
            
            let gEl = document.getElementById('msg-g');
            if (dG > 180) {
                gEl.style.opacity = "1";
                gEl.style.left = constrain(gold.x - 40, 20, width-100) + "px";
                gEl.style.top = (gold.y - 50) + "px";
                if (frameCount % 40 === 0 && navigator.vibrate) navigator.vibrate([50, 100, 50]);
            } else { gEl.style.opacity = "0"; }
            
            let rEl = document.getElementById('msg-r');
            if (dR > 110) {
                rEl.style.opacity = "1";
                rEl.style.left = constrain(red.x - 40, 20, width-100) + "px";
                rEl.style.top = (red.y + 40) + "px";
            } else { rEl.style.opacity = "0"; frames++; }
        }

        function clearMessages() {
            document.getElementById('msg-g').style.opacity = "0";
            document.getElementById('msg-r').style.opacity = "0";
        }

        function render() {
            document.getElementById('f-count').innerText = `flow: ${Math.floor(frames/60)}s`;
            document.getElementById('p-count').innerText = `üç∞: ${pEaten}`;
            document.getElementById('d-count').innerText = `üíé: ${dEaten}`;

            textAlign(CENTER, CENTER);
            items.forEach(i => {
                let char = i.t==='p'?'üç∞':'üíé';
                textSize(34); fill(255, 40); text(char, i.pos.x, i.pos.y);
                textSize(30); fill(255, 220); text(char, i.pos.x, i.pos.y);
            });
            
            strokeWeight(1.2); stroke(255, 18);
            line(gold.x, gold.y, white.x, white.y);
            line(white.x, white.y, red.x, red.y);
            noStroke();
            fill(212, 175, 55); ellipse(gold.x, gold.y, 30);
            fill(200, 50, 50); ellipse(red.x, red.y, 22);
            fill(255); ellipse(white.x, white.y, gameRunning ? 16 : 16 + pulse);
            fill(255, 25); ellipse(white.x, white.y, gameRunning ? 42 : 42 + pulse);
        }

        function finish() {
            if (frames < REQ_FRAMES) {
                let flash = document.getElementById('flash-msg');
                flash.style.opacity = "1";
                setTimeout(() => { flash.style.opacity = "0"; }, 2500);
                return;
            }

            clearMessages(); // Ensure all "Follow me" popups disappear
            gameRunning = false;
            document.getElementById('snd').pause();
            document.getElementById('end-screen').style.display = 'flex';
            document.getElementById('sum-txt').innerText = `you stayed in the flow for ${Math.floor(frames/60)}s.\n\nyou gathered ${pEaten} moments of sweetness\nand ${dEaten} moments of clarity.\n\nyou have reclaimed your focus.\nreturn to life.`;
        }
        function windowResized() { resizeCanvas(windowWidth, windowHeight); resetPositions(); }
    </script>
</body>
</html>
