<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The In-Between | Sensory Flow</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.js"></script>
    <style>
        * { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; touch-action: none; }
        body { margin: 0; padding: 0; background: #050505; overflow: hidden; cursor: crosshair; }
        
        #instruction-overlay {
            position: absolute; top: 100px; width: 100%;
            text-align: center; color: rgba(255, 255, 255, 0.6);
            font-family: 'Inter', -apple-system, sans-serif; font-weight: 200;
            font-size: 0.8rem; line-height: 2; letter-spacing: 3px;
            z-index: 200; transition: opacity 1.5s ease;
        }

        #stats-bar {
            position: absolute; top: 30px; width: 100%;
            display: flex; justify-content: center; gap: 40px;
            color: rgba(255, 255, 255, 0.2);
            font-family: 'Inter', sans-serif; font-weight: 200;
            font-size: 0.75rem; letter-spacing: 2px; pointer-events: none;
        }

        #quit-btn {
            position: absolute; bottom: 30px; right: 30px;
            color: rgba(255, 255, 255, 0.5); font-family: 'Inter', sans-serif;
            font-size: 0.75rem; letter-spacing: 2px; border: 1.5px solid rgba(255,255,255,0.3);
            background: rgba(0,0,0,0.4);
            padding: 10px 20px; border-radius: 25px; cursor: pointer;
            z-index: 300; transition: all 0.3s;
        }
        #quit-btn:hover { background: #fff; color: #000; }

        #end-screen {
            position: fixed; inset: 0; background: #050505;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            z-index: 1000; text-align: center; color: white; font-family: 'Inter', sans-serif;
        }

        .ios-bubble {
            position: absolute; background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 0.5px solid rgba(255, 255, 255, 0.2);
            padding: 8px 16px; border-radius: 20px; color: white;
            font-family: -apple-system, sans-serif; font-size: 13px;
            pointer-events: none; display: none; z-index: 100;
        }
    </style>
</head>
<body oncontextmenu="return false;">

    <audio id="bg-ocean" loop>
        <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg"> <source src="https://assets.mixkit.co/active_storage/sfx/2513/2513-preview.mp3" type="audio/mpeg">
    </audio>

    <div id="instruction-overlay">
        achieve flow state<br>
        collect rewards along the way<br>
        take care of red
    </div>

    <div id="stats-bar">
        <span id="flow-count">flow: 0s</span>
        <span id="dessert-count">üç∞: 0</span>
        <span id="diamond-count">üíé: 0</span>
    </div>

    <div id="quit-btn" onclick="endSession()">end session</div>

    <div id="end-screen">
        <h2 style="font-weight: 200; letter-spacing: 5px; font-size: 1.2rem;">session complete</h2>
        <p id="summary-text" style="color: #666; font-weight: 200; line-height: 1.8; max-width: 300px; margin-bottom: 40px; font-size: 0.9rem;"></p>
        <button onclick="location.reload()" style="background:none; border: 1px solid #333; color:#fff; padding: 12px 25px; border-radius: 25px; cursor:pointer; font-size: 0.75rem; letter-spacing: 2px;">return</button>
    </div>

    <div id="gold-msg" class="ios-bubble">follow me</div>
    <div id="red-msg" class="ios-bubble">thankyou</div>
    <div id="whoa-msg" class="ios-bubble" style="background: rgba(255, 0, 0, 0.2); border: 0.5px solid rgba(255, 0, 0, 0.4);">whoa...</div>

    <script>
        let gold, white, red;
        let items = [];
        let flowFrames = 0, dessertsEaten = 0, diamondsEaten = 0;
        let started = false;
        let angle = 0;
        const OFFSET_Y = -120;
        let oceanAudio;

        function setup() {
            createCanvas(windowWidth, windowHeight);
            gold = createVector(width/2, height*0.4);
            white = createVector(width/2, height/2);
            red = createVector(width/2, height*0.7);
            oceanAudio = document.getElementById('bg-ocean');
            oceanAudio.volume = 0.3; // Calming, low volume
        }

        function draw() {
            background(5, 5, 5, 85);

            angle += 0.006;
            let goldX = width/2 + cos(angle * 0.7) * (width * 0.3);
            let goldY = height/2 + sin(angle * 0.9) * (height * 0.25);
            let autonomousGold = createVector(goldX, goldY);

            if (mouseIsPressed || touches.length > 0) {
                if(!started) {
                    started = true;
                    oceanAudio.play();
                    document.getElementById('instruction-overlay').style.opacity = "0";
                    setTimeout(() => { document.getElementById('instruction-overlay').style.display = "none"; }, 1500);
                }
                let targetWhite = createVector(mouseX, mouseY + OFFSET_Y);
                white.lerp(targetWhite, 0.15);
            }

            if (started) {
                let magneticGold = p5.Vector.lerp(autonomousGold, white, 0.2);
                gold.lerp(magneticGold, 0.1); 
                red.lerp(white, 0.045);
            }

            if (started && frameCount % 130 === 0) {
                let type = random() > 0.4 ? 'dessert' : 'diamond';
                items.push({
                    pos: createVector(random(60, width-60), random(140, height-140)),
                    type: type,
                    life: 450
                });
            }

            for (let i = items.length - 1; i >= 0; i--) {
                let d = dist(white.x, white.y, items[i].pos.x, items[i].pos.y);
                if (d < 45) {
                    if (items[i].type === 'dessert') dessertsEaten++;
                    else diamondsEaten++;
                    items.splice(i, 1);
                    if ("vibrate" in navigator) navigator.vibrate(12);
                } else {
                    items[i].life--;
                    if (items[i].life <= 0) items.splice(i, 1);
                }
            }

            let distance = dist(white.x, white.y, gold.x, gold.y);
            let totalFlow = Math.floor(flowFrames / 60);
            
            updateUI(distance, totalFlow);
            drawElements(distance);
        }

        function updateUI(d, flow) {
            document.getElementById('flow-count').innerText = `flow: ${flow}s`;
            document.getElementById('dessert-count').innerText = `üç∞: ${dessertsEaten}`;
            document.getElementById('diamond-count').innerText = `üíé: ${diamondsEaten}`;

            let whoaMsg = document.getElementById('whoa-msg');
            
            if (d > 220 && started) {
                red.x += random(-3.5, 3.5); red.y += random(-3.5, 3.5);
                document.getElementById('gold-msg').style.display = 'block';
                document.getElementById('gold-msg').style.left = (gold.x + 20) + 'px';
                document.getElementById('gold-msg').style.top = (gold.y - 50) + 'px';
                
                // Show "whoa..." when red suffers
                whoaMsg.style.display = 'block';
                whoaMsg.style.left = (red.x - 30) + 'px';
                whoaMsg.style.top = (red.y + 30) + 'px';
                if (frameCount % 10 === 0) if ("vibrate" in navigator) navigator.vibrate(5);
            } else {
                if (started) flowFrames++;
                document.getElementById('gold-msg').style.display = 'none';
                whoaMsg.style.display = 'none';
            }

            let rMsg = document.getElementById('red-msg');
            rMsg.style.display = (flow >= 10 && d <= 220) ? 'block' : 'none';
            if (rMsg.style.display === 'block') {
                rMsg.style.left = (red.x + 20) + 'px';
                rMsg.style.top = (red.y + 20) + 'px';
            }
        }

        function drawElements(d) {
            textSize(22); textAlign(CENTER, CENTER);
            items.forEach(item => {
                let label = item.type === 'dessert' ? 'üç∞' : 'üíé';
                text(label, item.pos.x, item.pos.y);
            });

            strokeWeight(1.5);
            if (d > 220) {
                stroke(255, 40, 40, 100);
                for (let i = 0; i < 10; i++) {
                    line(lerp(white.x, red.x, i/10)+random(-4,4), lerp(white.y, red.y, i/10)+random(-4,4), 
                         lerp(white.x, red.x, (i+1)/10)+random(-4,4), lerp(white.y, red.y, (i+1)/10)+random(-4,4));
                }
            } else {
                stroke(255, 255, 255, 12);
                line(white.x, white.y, red.x, red.y);
            }
            stroke(255, 255, 255, 12);
            line(gold.x, gold.y, white.x, white.y);

            noStroke();
            fill(212, 175, 55); ellipse(gold.x, gold.y, 32, 32);
            fill(200, 50, 50); ellipse(red.x, red.y, 24, 24);
            fill(255); ellipse(white.x, white.y, 18, 18);
            fill(255, 255, 255, 30); ellipse(white.x, white.y, 45, 45);
        }

        function endSession() {
            oceanAudio.pause();
            let flow = Math.floor(flowFrames / 60);
            document.getElementById('end-screen').style.display = 'flex';
            document.getElementById('summary-text').innerText = 
                `flow attained: ${flow}s\n` +
                `sustenance (üç∞): ${dessertsEaten}\n` +
                `discipline (üíé): ${diamondsEaten}\n\n` +
                `you have reclaimed your focus.\nnow, return to life with intention.`;
        }

        function windowResized() { resizeCanvas(windowWidth, windowHeight); }
    </script>
</body>
</html>
