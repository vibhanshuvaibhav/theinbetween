<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The In-Between</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.js"></script>
    <style>
        * { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; touch-action: none; outline: none; }
        body { margin: 0; padding: 0; background: #050505; overflow: hidden; cursor: crosshair; }
        
        #gate, #end-screen {
            position: fixed; inset: 0; background: #050505; z-index: 2000;
            display: flex; align-items: center; justify-content: center; flex-direction: column;
        }

        .btn-ui {
            background: none; border: 1px solid #ffffff; color: #ffffff; 
            padding: 10px 28px; border-radius: 30px; cursor: pointer;
            font-family: sans-serif; font-weight: 200; font-size: 0.7rem; 
            letter-spacing: 3px; text-transform: lowercase; transition: all 0.6s ease;
        }
        .btn-ui:active { background: #ffffff; color: #000000; }

        #instruction-container {
            position: absolute; inset: 0; display: flex; flex-direction: column;
            align-items: center; justify-content: flex-end; z-index: 200;
            pointer-events: none; opacity: 0; transition: opacity 1s ease;
            padding-bottom: 15vh; /* Pushes text to bottom half */
        }

        #instruction-text {
            color: #ffffff; font-family: -apple-system, sans-serif; font-weight: 300; 
            font-size: 0.75rem; line-height: 2.8; letter-spacing: 1px; 
            text-align: center; text-transform: lowercase; margin-bottom: 25px;
        }

        #stats-bar {
            position: absolute; top: 40px; width: 100%; display: flex; 
            justify-content: center; gap: 30px; color: #ffffff; 
            font-family: sans-serif; font-weight: 300; font-size: 0.7rem; 
            letter-spacing: 1px; pointer-events: none; text-transform: lowercase; opacity: 0; transition: opacity 1s;
        }

        #action-btn-wrapper {
            position: absolute; bottom: 45px; left: 50%; transform: translateX(-50%);
            z-index: 300; display: none;
        }

        .bubble {
            position: absolute; background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 0.5px solid rgba(255, 255, 255, 0.2);
            padding: 8px 16px; border-radius: 20px; color: #ffffff;
            font-size: 11px; pointer-events: none; opacity: 0; transition: opacity 0.8s;
        }
    </style>
</head>
<body>

    <div id="gate">
        <button class="btn-ui" onclick="revealGame()">enter flow state</button>
    </div>

    <audio id="snd" loop playsinline preload="auto">
        <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
    </audio>

    <div id="instruction-container">
        <div id="instruction-text">
            follow the gold; it is your purpose<br>
            embrace the gifts found in the rhythm<br>
            protect the red; it's your peace<br>
            target 100s to enter flow state
        </div>
        <button id="start-btn" class="btn-ui" style="pointer-events: auto;" onclick="begin()">start</button>
    </div>

    <div id="stats-bar">
        <span id="f-count">flow: 0s</span>
        <span id="p-count">üç∞: 0</span>
        <span id="d-count">üíé: 0</span>
    </div>

    <div id="action-btn-wrapper">
        <button class="btn-ui" onclick="finish()">end session</button>
    </div>

    <div id="end-screen" style="display:none;">
        <p id="sum-txt" style="line-height: 2.2; margin-bottom: 20px; font-weight: 200; white-space: pre-line; font-size: 0.85rem; color: #fff; text-align: center;"></p>
        <button class="btn-ui" onclick="location.reload()">play again</button>
    </div>

    <div id="g-msg" class="bubble">follow me</div>
    <div id="w-msg" class="bubble" style="background: rgba(255, 255, 255, 0.05);">whoa...</div>

    <script>
        let gold, white, red, items = [];
        let frames = 0, pEaten = 0, dEaten = 0, active = false, gameRunning = false, angle = 0;
        const Y_OFF = -120;

        function setup() {
            createCanvas(windowWidth, windowHeight);
            // Initial positions: Top 25% of the screen to stay clear of instructions
            gold = createVector(width/2, height*0.2);
            white = createVector(width/2, height*0.25);
            red = createVector(width/2, height*0.3);
        }

        function revealGame() {
            document.getElementById('gate').style.display = 'none';
            document.getElementById('instruction-container').style.opacity = '1';
            let a = document.getElementById('snd');
            a.volume = 0.2;
            a.play().catch(()=>{});
            active = true; 
        }

        function begin() {
            gameRunning = true;
            document.getElementById('instruction-container').style.opacity = '0';
            setTimeout(() => { document.getElementById('instruction-container').style.display = 'none'; }, 1000);
            document.getElementById('action-btn-wrapper').style.display = 'block';
            document.getElementById('stats-bar').style.opacity = '0.6';
        }

        function draw() {
            background(5, 5, 5, 110);
            if (!active) return;

            if (gameRunning) {
                // Organic Movement Logic
                angle += 0.007;
                let targetG = createVector(width/2 + cos(angle*0.8)*(width*0.32), height/2 + sin(angle*0.6)*(height*0.22));
                let springG = p5.Vector.lerp(targetG, white, 0.12);
                gold.lerp(springG, 0.085);

                if (mouseIsPressed || (touches && touches.length > 0)) {
                    white.lerp(createVector(mouseX, mouseY + Y_OFF), 0.15);
                }
                red.lerp(white, 0.04);

                if (frameCount % 145 === 0) {
                    items.push({pos: createVector(random(60, width-60), random(140, height-140)), t: random()>0.4?'p':'d', l: 550});
                }
            } else {
                // Suspended "Idle" Animation for Start Screen
                angle += 0.002;
                gold.y = height*0.2 + sin(angle)*10;
                white.y = height*0.25 + cos(angle)*5;
                red.y = height*0.3 + sin(angle*1.2)*8;
            }

            // Shared Logic
            for (let i = items.length-1; i >= 0; i--) {
                if (dist(white.x, white.y, items[i].pos.x, items[i].pos.y) < 45) {
                    if (items[i].t === 'p') pEaten++; else dEaten++;
                    items.splice(i, 1);
                    if (navigator.vibrate) navigator.vibrate(6); 
                } else if (--items[i].l <= 0) items.splice(i, 1);
            }

            let d = dist(white.x, white.y, gold.x, gold.y);
            render(d);
        }

        function render(d) {
            document.getElementById('f-count').innerText = `flow: ${Math.floor(frames/60)}s`;
            document.getElementById('p-count').innerText = `üç∞: ${pEaten}`;
            document.getElementById('d-count').innerText = `üíé: ${dEaten}`;

            if (d > 215 && gameRunning) {
                red.x += random(-1.5, 1.5); red.y += random(-1.5, 1.5); 
                pop('g-msg', gold.x, gold.y - 50, true);
                pop('w-msg', red.x, red.y + 45, true);
            } else {
                if(gameRunning) frames++;
                pop('g-msg', 0, 0, false);
                pop('w-msg', 0, 0, false);
            }

            textSize(22); textAlign(CENTER, CENTER);
            items.forEach(i => text(i.t==='p'?'üç∞':'üíé', i.pos.x, i.pos.y));
            
            strokeWeight(1.2);
            stroke(255, d > 215 && gameRunning ? 45 : 18);
            line(gold.x, gold.y, white.x, white.y);
            line(white.x, white.y, red.x, red.y);

            noStroke();
            fill(212, 175, 55); ellipse(gold.x, gold.y, 30);
            fill(200, 50, 50); ellipse(red.x, red.y, 22);
            fill(255); ellipse(white.x, white.y, 16);
            fill(255, 25); ellipse(white.x, white.y, 42);
        }

        function pop(id, x, y, show) {
            let e = document.getElementById(id);
            if (show) { e.style.opacity = '1'; e.style.left = constrain(x, 40, width-100)+'px'; e.style.top = constrain(y, 40, height-70)+'px'; } 
            else { e.style.opacity = '0'; }
        }

        function finish() {
            gameRunning = false;
            document.getElementById('snd').pause();
            document.getElementById('end-screen').style.display = 'flex';
            document.getElementById('sum-txt').innerText = `you stayed in the flow for ${Math.floor(frames/60)}s.\n\nyou gathered ${pEaten} moments of sweetness\nand ${dEaten} moments of clarity.\n\nyou have reclaimed your focus.\nreturn to life.`;
        }

        function windowResized() { resizeCanvas(windowWidth, windowHeight); }
    </script>
</body>
</html>
